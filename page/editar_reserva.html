<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Editar Reserva - Cancha-easy!</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body>
    <nav class="navbar navbar-expand-md bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="inicio.html">
                <img src="../img/icon.svg" alt="Logo" height="50" class="d-inline-block align-text-top">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
                aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <a class="nav-link active mx-2" aria-current="page" href="deportes.html">Deportes</a>
                    <a class="nav-link mx-2" href="mireserva.html">Mis reservas</a>
                    <a class="nav-link mx-2" href="perfil.html">Mi perfil</a>
                    <a class="nav-link mx-2" href="index.html">Cerrar sesión</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="row text-center justify-content-center m-0 align-items-center">
            <div class="col-8 col-xl-6">
                <div id="calendario" class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                    <input type="date" id="fecha" class="form-control" aria-label="Fecha de reserva" min="" required>
                </div>
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-clock"></i></span>
                    <input type="time" id="horaInicio" class="form-control" aria-label="Hora de inicio" required>
                </div>
                <button id="btnGuardar" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            const params = new URLSearchParams(window.location.search);
            const idReserva = params.get('id');

            if (idReserva) {
                cargarDatosReserva(idReserva);
            } else {
                console.error('No se ha proporcionado el ID de la reserva para editar.');
            }

            // Configurar el campo de fecha para no permitir días anteriores a mañana
            const fechaInput = document.getElementById('fecha');
            const manana = new Date();
            manana.setDate(manana.getDate() + 1); // Obtener fecha de mañana
            const mananaISO = manana.toISOString().split('T')[0]; // Formato ISO para input date
            fechaInput.setAttribute('min', mananaISO);

            $('#btnGuardar').on('click', function () {
                const fecha = $('#fecha').val();
                const horaInicio = $('#horaInicio').val();

                if (fecha && horaInicio) {
                    const datosActualizados = {
                        usuario: "12345678-9", // Usuario especificado
                        cancha: 1, // Cancha especificada
                        fecha: fecha,
                        hora_inicio: horaInicio,
                        hora_fin: calcularHoraTermino(horaInicio)
                    };

                    $.ajax({
                        url: `http://127.0.0.1:8000/api/reservas/${idReserva}/`,
                        method: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify(datosActualizados),
                        success: function () {
                            alert('Reserva actualizada correctamente.');
                            window.location.href = 'mireserva.html';
                        },
                        error: function (error) {
                            console.error('Error al actualizar la reserva:', error);
                            alert('Error al actualizar la reserva.');
                        }
                    });
                }
            });
        });

        function cargarDatosReserva(idReserva) {
            $.ajax({
                url: `http://127.0.0.1:8000/api/reservas/${idReserva}/`,
                method: 'GET',
                success: function (reserva) {
                    $('#fecha').val(reserva.fecha);
                    $('#horaInicio').val(reserva.hora_inicio.slice(0, 5));
                }
            });
        }

        function calcularHoraTermino(horaInicio) {
            const horaInicioDate = new Date(`2000-01-01T${horaInicio}`);
            const horaFinDate = new Date(horaInicioDate.getTime() + (60 * 60 * 1000));
            return horaFinDate.toLocaleTimeString('es-CL', { hour12: false }).slice(0, 5);
        }
    </script>
</body>

</html>